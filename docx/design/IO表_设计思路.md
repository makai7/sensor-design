# 多模态测距与定位系统硬件设计方案

## 1. 总体硬件架构 (Block Diagram)

系统采用 **STM32F407VGT6** 作为核心处理单元，通过总线架构挂载三个核心传感子系统。设计遵循“高内聚、低耦合”原则，确保声学 DSP 处理的实时性。

* **核心主控 (MCU)**: STM32F407 (168MHz, Cortex-M4F), 负责 I2S DMA 数据搬运、GCC-PHAT 运算 以及多模态数据融合 。
* **感知层 A - 被动声学 (Passive Acoustic)**:
    * **传感器**: 4x MEMS 全向麦克风 (如 INMP441)。
    * **接口**: 双路 I2S 接口 (同步模式)，通过 DMA 采集。
    * **功能**: 提供原始音频波形，用于 TDOA 时间差计算及 AoA 方向估计 。
* **感知层 B - 主动光学 (Active Optical)**:
    * **传感器**: 单点 ToF 测距模块 (如 VL53L0X)。
    * **接口**: I2C 总线。
    * **功能**: 提供高精度绝对距离测量及信号置信度 。
* **感知层 C - 视觉辅助 (Vision Support)**:
    * **传感器**: 智能视觉模块 (如 OpenMV/K210)。
    * **接口**: UART 串口。
    * **功能**: 输出目标角度 $\theta_v$ 或检测框坐标，减轻 MCU 图像处理负担 。
* **数据与调试层**:
    * USB-TTL (连接 PC 上位机进行波形显示与参数校准 )。
    * SWD 调试接口。

---

## 2. IO 资源分配表 (Resource Map)

基于 **STM32F407VGT6 (100-pin LQFP)** 的引脚分配。

### 2.1 麦克风阵列接口 (核心资源)
> **设计策略**: 使用 I2S2 作为主时钟源，I2S3 作为从设备（或数据接收端），**物理共用 SCK 和 WS 信号**以确保 4 路麦克风微秒级同步。

| 功能模块 | 信号名称 | STM32 引脚 | 外设资源 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| **Mic Pair 1 (L/R)** | **SCK** (位时钟) | **PB10** | **I2S2_CK** | **主时钟源**，连接所有 4 个麦克风的 SCK |
| | **WS** (帧时钟) | **PB12** | **I2S2_WS** | **主时钟源**，连接所有 4 个麦克风的 WS |
| | **SD_1** (数据) | **PC3** | **I2S2_SD** | 接收麦克风 1 (L) 和 2 (R) 的数据 |
| **Mic Pair 2 (L/R)** | SCK | (N/A) | (N/A) | 外部物理连接至 PB10 |
| | WS | (N/A) | (N/A) | 外部物理连接至 PB12 |
| | **SD_2** (数据) | **PC12** | **I2S3_SD** | 接收麦克风 3 (L) 和 4 (R) 的数据 |

* **DMA 配置**:
    * I2S2_RX -> DMA1_Stream3
    * I2S3_RX -> DMA1_Stream0 (或 Stream2)
    * *注: 需开启双缓冲或循环模式 (Circular Mode) 以保证音频流连续。*

### 2.2 光学 ToF 与 视觉接口

| 功能模块 | 信号名称 | STM32 引脚 | 外设资源 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| **ToF Sensor** | **SCL** | **PB6** | **I2C1_SCL** | 需 4.7kΩ 上拉电阻 |
| | **SDA** | **PB7** | **I2C1_SDA** | 需 4.7kΩ 上拉电阻 |
| | **XSHUT** | **PD0** | GPIO_Output | 传感器复位/地址修改控制 |
| | **INT** | **PD1** | GPIO_Input | (可选) 数据就绪中断 |
| **Vision/Camera** | **TX** (Cam->MCU) | **PA3** | **USART2_RX** | 接收视觉角度数据 |
| | **RX** (MCU->Cam) | **PA2** | **USART2_TX** | 发送控制指令 (可选) |

### 2.3 系统与调试接口

| 功能模块 | 信号名称 | STM32 引脚 | 外设资源 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| **PC Debug** | **TX** | **PA9** | **USART1_TX** | 波特率建议 115200 或 921600 |
| | **RX** | **PA10** | **USART1_RX** | |
| **HSE Clock** | **OSC_IN/OUT** | **PH0/PH1** | **RCC** | **必须使用 8MHz 外部晶振** (保证 I2S 频率精准) |
| **SWD Debug** | SWDIO | PA13 | SYS | 仿真器数据线 |
| | SWCLK | PA14 | SYS | 仿真器时钟线 |
| **Status** | LED | PE0 | GPIO | 系统心跳指示灯 |

---

## 3. 模块化设计细节 (Design Implementation)

### 3.1 麦克风阵列模块 (The Array)
这是系统的核心，通过测量 $\Delta t$ 来计算 AoA 。
* **物理布局**:
    * 建议采用 **均匀线阵 (ULA)** 或 **均匀圆阵 (UCA)**。
    * **基线距离 ($d$)**: 麦克风间距需根据最高目标频率设计，通常 $d < \lambda / 2$ 以避免空间混叠。建议间距 3cm - 10cm 。
* **电气连接**:
    * 所有麦克风的 `SCK` 并联，接 PB10。
    * 所有麦克风的 `WS` 并联，接 PB12。
    * **L/R 选择**:
        * Mic 1: L/R 接 GND (左声道), 数据线接 PC3。
        * Mic 2: L/R 接 VDD (右声道), 数据线接 PC3。
        * Mic 3: L/R 接 GND (左声道), 数据线接 PC12。
        * Mic 4: L/R 接 VDD (右声道), 数据线接 PC12。
* **电源**: 必须使用低噪声 LDO (如 XC6206-3.3V) 单独供电，避免数字电源噪声耦合进音频信号。

### 3.2 光学 ToF 模块 (Active Sensing)
* **安装位置**: 安装在麦克风阵列的物理几何中心，作为系统的坐标原点 $(0,0)$。
* **工作逻辑**: MCU 通过 I2C 读取距离 ($d$) 和信号强度 ($S$)，将其映射为置信度 $C_{opt}$ 。

### 3.3 视觉模块 (Vision)
* **分工**: 不在 STM32 上进行图像处理。视觉模块自行完成目标检测，通过串口仅发送 `[Header, Angle, Confidence, Checksum]` 数据包。
* **校准**: 需提前标定相机内参，确保输出的角度 $\theta_v$ 准确 。

### 3.4 电源管理
* **输入**: 5V USB 供电。
* **电源树**:
    * 5V -> **AMS1117-3.3** -> STM32 VCC, ToF, Camera, Logic.
    * 5V -> **Low Noise LDO 3.3V** -> MEMS 麦克风阵列 (模拟电源 VDD).
    * **GND**: 模拟地 (AGND) 与数字地 (DGND) 在电源入口处单点连接。






---
# 设计思路细节
### 1. 被动声学阵列模块 (Acoustic Array Module)
**核心目标**：构建 4 路高一致性的数字麦克风阵列。
**选型建议**：**INMP441** (InvenSense) 或 **ICS-43434** (TDK)。
*理由：这些是 I2S 数字输出的全向 MEMS 麦克风，内部集成了 ADC 和抗混叠滤波器，直接输出数字音频流，避免了模拟信号在长走线上的噪声干扰，符合 DSP 处理需求。*

#### A. 单个麦克风电路设计 (Schematic Detail)
每个 INMP441 芯片（LGA 封装）需要以下分立器件支持：

1.  **电源滤波 (关键)**
    * MEMS 麦克风对电源噪声极度敏感（PSRR）。
    * **设计**: 在每个麦克风的 `VDD` 和 `GND` 引脚极近处，放置一个 **0.1µF (100nF) 陶瓷电容** (高频滤波) 和一个 **10µF 陶瓷/钽电容** (储能)。
    * *元器件清单*: 0402封装 0.1µF电容 x4, 0603封装 10µF电容 x4。

2.  **L/R 声道配置 (L/R Selection)**
    * 利用 `L/R` 引脚电平决定该麦克风的数据出现在 I2S 帧的左声道还是右声道。
    * **左声道麦克风**: `L/R` 引脚直接 **接地 (GND)**。
    * **右声道麦克风**: `L/R` 引脚直接 **接电源 (VDD)**。

3.  **阻抗匹配与信号完整性**
    * **SD (数据线)**: 由于两个麦克风共享一条 SD 线（分时复用），建议在每个麦克风的 SD 输出引脚串联一个 **33Ω - 100Ω 电阻**。这可以减少信号反射振铃，保护 IO 口。
    * **下拉电阻**: 在总的 SD 数据线上放置一个 **10kΩ - 47kΩ 下拉电阻**，防止总线在空闲时浮空引入噪声。

#### B. 阵列 PCB 布局指南 (Layout)
* **声孔 (Sound Port)**: INMP441 是**底部拾音 (Bottom Port)**。
    * **设计**: 需要在 PCB 上打一个孔（直径约 0.5mm - 0.8mm）。
    * **重点**: 芯片的拾音孔必须与 PCB 上的孔完美对齐。芯片周围的 GND 焊盘（Ring）必须完整焊接，形成密封声腔，防止漏音导致频响变差。
* **走线**:
    * I2S 时钟线 (`SCK`, `WS`) 是高频数字信号，走线尽量等长。
    * 远离电源开关电路（如 DC-DC 电感）。

---

### 2. 光学 ToF 模块 (Optical ToF Module)
**核心目标**：驱动激光测距传感器并保证 I2C 通信稳定。
**选型建议**：**VL53L0X** (ST Microelectronics) 裸片。

#### A. 核心电路设计
VL53L0X 是一个复杂的 SoC，封装为 LGA-12。

1.  **电源域 (Power Rails)**
    * 该芯片通常需要 **2.8V** 供电（部分 Datasheet 标称 AVDD 最高 3.5V，但推荐 2.8V 以获得最佳信噪比）。
    * **LDO 设计**: 不要直接用 STM32 的 3.3V 供电，建议加一颗独立的 **2.8V LDO** (如 RT9193-2.8 或 XC6206-2.8)。
    * **滤波**: AVDD (Pin 1) 和 AVDDVCSEL (Pin 11) 需要极其干净的电源。务必放置 **100nF** 和 **4.7µF** 去耦电容，且尽量靠近引脚。

2.  **I2C 电平转换 (Level Shifting)**
    * STM32 是 3.3V 逻辑，VL53L0X (在 2.8V 供电下) 是 2.8V 逻辑。虽然 I2C 是开漏结构，直接上拉到 2.8V 也能工作（STM32 识别 $0.7 \times 3.3V \approx 2.3V$ 为高电平），但为了稳健：
    * **方案**: 将 I2C 上拉电阻（2.2kΩ - 4.7kΩ）连接到 **2.8V** (ToF 的电源)，而不是 3.3V。STM32 的 I2C 引脚通常兼容低电平输入，这样最安全。

3.  **XSHUT (复位) 控制**
    * `XSHUT` 引脚用于硬件复位和地址修改。
    * **设计**: 需通过一个 **10kΩ 上拉电阻** 接到 2.8V。STM32 的 GPIO 控制它时，建议配置为 **Open-Drain (开漏输出)** 模式，这样 STM32 只输出低电平（复位），高电平由电阻拉到 2.8V，避免 3.3V 倒灌进传感器。

#### B. 机械与光学设计 (关键！)
* **盖片 (Cover Glass)**: 如果你的 PCB 外面有外壳，红外光需要穿过玻璃。
    * **串扰 (Crosstalk)**: 发射的红外光如果在玻璃内部反射回接收器，会导致严重的“近距离盲区”或错误读数。
    * **解决**: 必须在 PCB 上设计**遮光垫圈 (Gasket)**，将发射孔和接收孔在物理上隔离，或者紧贴外壳不留空隙。

---

### 3. 视觉/摄像头接口 (Vision Sensor Interface)
如果你要自己画摄像头部分（而不是用现成的 OpenMV），最简单的方案是使用 **DCMI 接口** 的传感器。
**选型**: **OV2640** 或 **OV7725** (裸片/模组插针)。

* **时钟**: 需要一个 **24MHz 有源晶振** 或者由 STM32 的 MCO 引脚提供 XCLK 时钟。
* **电源**: 摄像头通常需要三路电源：
    * **AVDD (模拟)**: 2.8V (最敏感，需独立 LDO)。
    * **DVDD (数字核)**: 1.2V/1.5V (需 LDO)。
    * **DOVDD (IO)**: 3.3V (与 STM32 通信)。
* **设计建议**: 由于摄像头布线对阻抗和等长要求极高（8根数据线 + PCLK + VSYNC + HSYNC），**这部分设计为一个“接口插座”（2x10 Pin Header），购买现成的“OV2640 裸板模块”插上去。这样依然完成了系统集成，但规避了 BGA 焊接和高频信号完整性的极高风险。

---

### 4. 汇总：“分立元件”物料清单 (BOM)

| 模块 | 核心芯片 | 分立元件 (关键) | 备注 |
| :--- | :--- | :--- | :--- |
| **电源** | LDO (3.3V, 2.8V) | 10uF, 0.1uF 电容若干 | 模拟/数字电源分离 |
| **声学** | **INMP441** x4 | 0.1uF 电容 x4 (去耦) | 必须是 LGA 封装 |
| | | 33Ω 电阻 x4 (源端匹配) | |
| | | 47kΩ 电阻 x1 (数据下拉) | |
| **光学** | **VL53L0X** x1 | 100nF, 4.7uF 电容 | 必须是 LGA 封装 |
| | | 4.7kΩ 电阻 x2 (I2C上拉) | 接 2.8V 电源 |
| | | 10kΩ 电阻 x1 (复位上拉) | |
| **主控** | **STM32F407** | 8MHz 晶振, 22pF 电容 | 系统心跳 |

