/* Core/Src/ov2640.c */
#include "ov2640.h"
#include <stdio.h> // 用于printf调试（如果有串口）

// ==========================================
// OV2640 配置表: QQVGA (160x120), RGB565
// ==========================================
const uint8_t OV2640_QQVGA[][2] = {
    {0xff, 0x01}, {0x12, 0x80}, {0xff, 0x00}, {0x2c, 0xff}, {0x2e, 0xdf},
    {0xff, 0x01}, {0x3c, 0x32}, {0x11, 0x00}, {0x09, 0x02}, {0x04, 0x28},
    {0x13, 0xe5}, {0x14, 0x48}, {0x2c, 0x0c}, {0x33, 0x78}, {0x3a, 0x33},
    {0x3b, 0xfb}, {0x3e, 0x00}, {0x43, 0x11}, {0x16, 0x10}, {0x39, 0x02},
    {0x35, 0x88}, {0x22, 0x0a}, {0x37, 0x40}, {0x23, 0x00}, {0x34, 0xa0},
    {0x06, 0x02}, {0x06, 0x88}, {0x07, 0xc0}, {0x0d, 0xb7}, {0x0e, 0x01},
    {0x4c, 0x00}, {0x4a, 0x81}, {0x21, 0x99}, {0x24, 0x40}, {0x25, 0x38},
    {0x26, 0x82}, {0x5c, 0x00}, {0x63, 0x00}, {0x46, 0x22}, {0x0c, 0x3a},
    {0x5d, 0x55}, {0x5e, 0x7d}, {0x5f, 0x7d}, {0x60, 0x55}, {0x61, 0x70},
    {0x62, 0x80}, {0x7c, 0x05}, {0x20, 0x80}, {0x28, 0x30}, {0x6c, 0x00},
    {0x6d, 0x80}, {0x6e, 0x00}, {0x70, 0x02}, {0x71, 0x94}, {0x73, 0xc1},
    {0x3d, 0x34}, {0x5a, 0x57}, {0x4f, 0xbb}, {0x50, 0x9c}, {0xff, 0x00},
    {0xe5, 0x7f}, {0xf9, 0xc0}, {0x41, 0x24}, {0xe0, 0x14}, {0x76, 0xff},
    {0x33, 0xa0}, {0x42, 0x20}, {0x43, 0x18}, {0x4c, 0x00}, {0x87, 0xd0},
    {0x88, 0x3f}, {0xd7, 0x03}, {0xd9, 0x10}, {0xd3, 0x82}, {0xc8, 0x08},
    {0xc9, 0x80}, {0x7c, 0x00}, {0x7d, 0x00}, {0x7c, 0x03}, {0x7d, 0x48},
    {0x7d, 0x48}, {0x7c, 0x08}, {0x7d, 0x20}, {0x7d, 0x10}, {0x7d, 0x0e},
    {0x90, 0x00}, {0x91, 0x0e}, {0x91, 0x1a}, {0x91, 0x31}, {0x91, 0x5a},
    {0x91, 0x69}, {0x91, 0x75}, {0x91, 0x7e}, {0x91, 0x88}, {0x91, 0x8f},
    {0x91, 0x96}, {0x91, 0xa3}, {0x91, 0xaf}, {0x91, 0xc4}, {0x91, 0xd7},
    {0x91, 0xe8}, {0x91, 0x20}, {0x92, 0x00}, {0x93, 0x06}, {0x93, 0xe3},
    {0x93, 0x03}, {0x93, 0x03}, {0x93, 0x00}, {0x93, 0x02}, {0x93, 0x00},
    {0x93, 0x00}, {0x93, 0x00}, {0x93, 0x00}, {0x93, 0x00}, {0x93, 0x00},
    {0x93, 0x00}, {0x96, 0x00}, {0x97, 0x08}, {0x97, 0x19}, {0x97, 0x02},
    {0x97, 0x0c}, {0x97, 0x24}, {0x97, 0x30}, {0x97, 0x28}, {0x97, 0x26},
    {0x97, 0x02}, {0x97, 0x98}, {0x97, 0x80}, {0x97, 0x00}, {0x97, 0x00},
    {0xa4, 0x00}, {0xa8, 0x00}, {0xc5, 0x11}, {0xc6, 0x51}, {0xbf, 0x80},
    {0xc7, 0x10}, {0xb6, 0x66}, {0xb8, 0xA5}, {0xb7, 0x64}, {0xb9, 0x7C},
    {0xb3, 0xaf}, {0xb4, 0x97}, {0xb5, 0xff}, {0xb0, 0xc5}, {0xb1, 0x94},
    {0xb2, 0x0f}, {0xc4, 0x5c}, {0xa6, 0x00}, {0xa7, 0x20}, {0xa7, 0xd8},
    {0xa7, 0x1b}, {0xa7, 0x31}, {0xa7, 0x00}, {0xa7, 0x18}, {0xa7, 0x20},
    {0xa7, 0xd8}, {0xa7, 0x19}, {0xa7, 0x31}, {0xa7, 0x00}, {0xa7, 0x18},
    {0x7f, 0x00}, {0xe5, 0x1f}, {0xe1, 0x77}, {0xdd, 0x7f}, {0xC2, 0x0e},
    // QQVGA (160x120) 特定设置
    {0xff, 0x01}, {0x04, 0x20}, // QQVGA
    {0xff, 0x00}, {0x44, 0x32}, // RGB565, 2x Bytes
    
    // 降低PCLK速度 (关键！F103必须降速)
    // 0x11寄存器: Bit[5:0]是分频系数。数值越大越慢。
    // 0x03=4分频，0x07=8分频。如果读取不稳定，把 0x03 改大。
    {0xff, 0x01}, {0x11, 0x03}, 
    
    {0xff, 0xff} // 结束标志
};

uint8_t OV2640_Init(void) {
    uint8_t pid, ver;
    uint16_t i = 0; // 循环变量
    
    SCCB_Init(); 
    
    // 1. 软复位 (保险起见)
    SCCB_WR_Reg(0xff, 0x01);
    SCCB_WR_Reg(0x12, 0x80);
    HAL_Delay(100); // 等复位完成

    // 2. 检查 ID
    SCCB_WR_Reg(0xFF, 0x01);
    pid = SCCB_RD_Reg(OV2640_PID);
    ver = SCCB_RD_Reg(OV2640_VER);
    
    if (pid != 0x26 || ver != 0x42) {
        return 1; // 失败
    }

    // 3. === 写入配置表 ===
    while (1) {
        uint8_t reg = OV2640_QQVGA[i][0];
        uint8_t val = OV2640_QQVGA[i][1];
        
        if (reg == 0xff && val == 0xff) break; // 遇到结束标志退出
        
        SCCB_WR_Reg(reg, val);
        i++;
    }
    
    return 0; // 成功
}